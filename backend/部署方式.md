# Realtime Dialogue Backend

基於 FastAPI 的即時語音對話後端服務，整合了 STT（語音轉文字）和 TTS（文字轉語音）功能。

## 技術棧

- **框架**: FastAPI
- **STT**: Faster-Whisper (Large-v3 模型)
- **TTS**: BreezyVoice (台灣華語語音合成)
- **容器化**: Podman/Docker

## 功能特色

1. **語音轉文字 (STT)**: 使用 Faster-Whisper，支援中文語音辨識
2. **文字轉語音 (TTS)**: 使用 BreezyVoice，專為台灣華語優化
3. **聊天對話**: 內建聊天機器人邏輯
4. **完整對話流程**: 語音輸入 → 文字 → 聊天 → 語音輸出
5. **RESTful API**: 標準 HTTP API 介面

## 快速開始

### 使用 Podman 啟動

```bash
# 建置並啟動服務
./start-podman.sh

# 或手動執行
# 停止當前容器
podman stop realtime-dialogue-backend
podman rm realtime-dialogue-backend

# 重新建構
cd /data/paul.fc.tsai_data/realtime-dialogue/backend
podman build --no-cache -t realtime-dialogue-backend .

# 啟動容器
cd /data/paul.fc.tsai_data/realtime-dialogue && podman run -d -p 8945:8000 --gpus all -v ./backend:/app:z -v ./models:/app/models:z -e LD_LIBRARY_PATH="/usr/local/lib/python3.10/dist-packages/nvidia/cudnn/lib:/usr/local/lib/python3.10/dist-packages/ctranslate2.libs:/usr/local/nvidia/lib:/usr/local/nvidia/lib64" -e FIPS_MODE=0 -e OPENSSL_FIPS=0 -e LIBCRYPTO_FIPS=0 --name realtime-dialogue-backend realtime-dialogue-backend

podman exec -it realtime-dialogue-backend bash -c "
# 創建 CUDNN 9.1 的符號鏈接到 CUDNN 8
cd /usr/local/lib/python3.10/dist-packages/nvidia/cudnn/lib/

# 檢查現有文件
ls -la libcudnn*

# 為 CUDNN 9.1 版本創建符號鏈接
ln -sf libcudnn_ops_infer.so.8 libcudnn_ops.so.9.1.0
ln -sf libcudnn_ops_infer.so.8 libcudnn_ops.so.9.1
ln -sf libcudnn_ops_infer.so.8 libcudnn_ops.so.9
ln -sf libcudnn_ops_infer.so.8 libcudnn_ops.so

echo 'Created symbolic links:'
ls -la libcudnn_ops*
"

podman exec -it realtime-dialogue-backend bash
```

### 測試 API

```bash
# 執行 API 測試
./test-api.sh
```

## API 端點

### 基本端點

- `GET /`: 服務資訊
- `GET /health`: 健康檢查
- `GET /docs`: API 文件 (Swagger UI)

### 核心功能

- `POST /stt`: 語音轉文字
  - 上傳音檔，回傳辨識文字
  
- `POST /tts`: 文字轉語音  
  - 輸入文字，回傳語音檔案
  
- `POST /chat`: 聊天對話
  - 輸入文字，回傳機器人回覆
  
- `POST /conversation`: 完整對話流程
  - 輸入語音，回傳機器人語音回覆

## 服務地址

- **主服務**: http://10.204.245.170:8945
- **API 文件**: http://10.204.245.170:8945/docs
- **健康檢查**: http://10.204.245.170:8945/health

## 開發模式

```bash
# 安裝依賴
pip install -r requirements.txt

# 啟動開發服務器
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

## 容器管理

```bash
# 查看日誌
podman logs -f realtime-dialogue-backend

# 停止服務
podman stop realtime-dialogue-backend

# 移除容器
podman rm realtime-dialogue-backend

# 重新建置
podman build -t realtime-dialogue-backend .
```

## 注意事項

1. **模型下載**: 首次啟動會自動下載 Faster-Whisper 和 BreezyVoice 模型，需要網路連線
2. **GPU 支援**: 如果有 NVIDIA GPU，會自動使用 CUDA 加速
3. **記憶體需求**: 建議至少 4GB RAM
4. **儲存空間**: 模型檔案約需 3-5GB 空間

## 故障排除

### 常見問題

1. **模型下載失敗**: 檢查網路連線，或使用代理服務器
2. **CUDA 錯誤**: 確認 GPU 驅動程式版本，或改用 CPU 模式
3. **記憶體不足**: 調整 worker 數量或使用較小的模型

### 查看日誌

```bash
# 查看容器日誌
podman logs realtime-dialogue-backend

# 即時查看日誌
podman logs -f realtime-dialogue-backend
```
