# 使用 Python 3.10 with CUDA 12.1 支援
FROM nvidia/cuda:12.1.0-devel-ubuntu22.04

# 避免交互式提示
ENV DEBIAN_FRONTEND=noninteractive

# 設定工作目錄
WORKDIR /app

# 設定環境變數來解決 OpenSSL FIPS 問題
ENV OPENSSL_CONF=""
ENV OPENSSL_FIPS=""
ENV OPENSSL_MODULES=""

# 安裝 Python 3.10 和系統依賴
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    python3-distutils \
    git \
    wget \
    curl \
    build-essential \
    ffmpeg \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3 /usr/bin/python

# 複製 requirements.txt 並安裝 Python 依賴
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 建立必要目錄
RUN mkdir -p /app/uploads /app/outputs /app/models

# 複製本地的 BreezyVoice 目錄（假設已經在本地 clone）
COPY BreezyVoice/ ./BreezyVoice/

# 進入 BreezyVoice 目錄並安裝依賴
WORKDIR /app/BreezyVoice
RUN pip install --no-cache-dir -r requirements.txt || echo "Some packages may have failed, continuing..."

# 手動安裝 BreezyVoice 的特殊依賴
RUN pip install https://www.modelscope.cn/models/speech_tts/speech_kantts_ttsfrd/resolve/master/ttsfrd_dependency-0.1-py3-none-any.whl || echo "ttsfrd_dependency install failed, continuing..."
RUN pip install https://www.modelscope.cn/models/speech_tts/speech_kantts_ttsfrd/resolve/master/ttsfrd-0.3.9-cp310-cp310-linux_x86_64.whl || echo "ttsfrd install failed, continuing..."

# 回到主工作目錄
WORKDIR /app

# 複製應用程式代碼
COPY app/ ./app/

# 複製 llm_tools 會在啟動腳本中掛載

# 設定環境變數
ENV PYTHONPATH=/app
ENV PYTHONUTF8=1
ENV HF_HUB_CACHE=/app/models
ENV TRANSFORMERS_CACHE=/app/models

# 暴露端口
EXPOSE 8000

# 改為使用 tail 保持容器運行，方便進入容器測試
CMD ["tail", "-f", "/dev/null"]
